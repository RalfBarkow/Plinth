##
## On all sites, provide cockpit on the path: /_cockpit/
##
## Requires the following Apache modules to be enabled:
##   mod_headers
##   mod_proxy
##   mod_proxy_http
##   mod_proxy_wstunnel
##
<Location >
    # See "Running DMX behind an Apache Reverse Proxy" 
    #   @ https://dmx.readthedocs.io/en/latest/admin.html#running-dmx-behind-an-apache-reverse-proxy
    
    # See "Configuring Apache mod_proxy with Jetty" 
    #   @ https://wiki.eclipse.org/Jetty/Howto/Configure_mod_proxy
    # ->  Configure Jetty with a normal HTTP connector, on port 8080 or similar.

    # Turn off forward proxy. 
    
    ProxyRequests Off

    <Proxy *>
    Order deny,allow
    Allow from all
    </Proxy>

    # This is the forwarding for the websockets. Always keep it the first rule.
    # Do not forget to enable module proxy_wstunnel

    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket
    RewriteRule /(.*) ws://localhost:8081/$1 [NE,P,L]

    # Configure reverse proxy paths with the URL of the Jetty server: 
    
    ProxyPass http://localhost:8080/

    # Frequently Apache documentation instructs that you use ProxyPassReverse configuration 
    # so that Apache can rewrite any URLs in headers. However, if you use the ProxyPreserveHost configuration, 
    # Jetty can generate the correct URLs, and rewriting is not necessary: 
    
    ProxyPreserveHost On
</Location>
